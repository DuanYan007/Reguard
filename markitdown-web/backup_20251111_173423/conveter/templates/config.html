<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - MarkItDown Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .config-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 30px auto;
            padding: 40px;
            max-width: 1200px;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .section-title i {
            margin-right: 10px;
            color: #667eea;
        }

        .form-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .alert {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .config-value {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            border-left: 3px solid #667eea;
        }

        .feature-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .feature-switch:last-child {
            border-bottom: none;
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="config-container">
            <!-- 页面标题 -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-dark">
                    <i class="fas fa-cogs text-primary me-3"></i>配置管理
                </h1>
                <p class="text-muted">管理 MarkItDown Web 应用的配置参数</p>
            </div>

            <!-- 操作按钮 -->
            <div class="mb-4">
                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>保存配置
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="reloadConfig()">
                        <i class="fas fa-sync-alt me-2"></i>重新加载
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="exportConfig()">
                        <i class="fas fa-download me-2"></i>导出配置
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload me-2"></i>导入配置
                    </button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importConfig(event)">
                </div>
            </div>

            <!-- 状态消息 -->
            <div id="statusMessage"></div>

            <!-- 配置表单 -->
            <div id="configForm" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-3">正在加载配置...</p>
            </div>

            <!-- 返回链接 -->
            <div class="text-center mt-4">
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>返回主页
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentConfig = {};
        let originalConfig = {};

        // 页面加载时获取配置
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
        });

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const result = await response.json();

                if (result.success) {
                    currentConfig = result.config;
                    originalConfig = JSON.parse(JSON.stringify(result.config)); // 深拷贝
                    renderConfigForm();
                } else {
                    showMessage('加载配置失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('加载配置异常: ' + error.message, 'danger');
            }
        }

        function renderConfigForm() {
            const formContainer = document.getElementById('configForm');

            let html = `
                <!-- 应用配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-server"></i>应用配置
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Debug模式</label>
                            <select class="form-select" id="app_debug">
                                <option value="true" ${currentConfig.app?.debug ? 'selected' : ''}>启用</option>
                                <option value="false" ${!currentConfig.app?.debug ? 'selected' : ''}>禁用</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">监听端口</label>
                            <input type="number" class="form-control" id="app_port"
                                   value="${currentConfig.app?.port || 5000}" min="1" max="65535">
                        </div>
                        <div class="col-md-12 mt-3">
                            <label class="form-label">监听主机</label>
                            <input type="text" class="form-control" id="app_host"
                                   value="${currentConfig.app?.host || '0.0.0.0'}">
                        </div>
                    </div>
                </div>

                <!-- 存储配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-folder-open"></i>存储配置
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">上传目录</label>
                            <input type="text" class="form-control" id="storage_upload_folder"
                                   value="${currentConfig.storage?.upload_folder || 'uploads'}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">下载目录</label>
                            <input type="text" class="form-control" id="storage_download_folder"
                                   value="${currentConfig.storage?.download_folder || 'downloads'}">
                        </div>
                        <div class="col-md-6 mt-3">
                            <label class="form-label">历史记录文件</label>
                            <input type="text" class="form-control" id="storage_history_file"
                                   value="${currentConfig.storage?.history_file || 'history.json'}">
                        </div>
                        <div class="col-md-6 mt-3">
                            <label class="form-label">批量状态文件</label>
                            <input type="text" class="form-control" id="storage_batch_status_file"
                                   value="${currentConfig.storage?.batch_status_file || 'batch_status.json'}">
                        </div>
                    </div>
                </div>

                <!-- 限制配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-sliders-h"></i>限制配置
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">最大文件大小 (bytes)</label>
                            <input type="number" class="form-control" id="limits_max_file_size"
                                   value="${currentConfig.limits?.max_file_size || 104857600}" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">最大历史记录数</label>
                            <input type="number" class="form-control" id="limits_max_history_records"
                                   value="${currentConfig.limits?.max_history_records || 100}" min="1">
                        </div>
                        <div class="col-md-6 mt-3">
                            <label class="form-label">批量状态轮询间隔 (ms)</label>
                            <input type="number" class="form-control" id="limits_batch_status_poll_interval"
                                   value="${currentConfig.limits?.batch_status_poll_interval || 2000}" min="100">
                        </div>
                        <div class="col-md-6 mt-3">
                            <label class="form-label">临时文件清理时间 (小时)</label>
                            <input type="number" class="form-control" id="limits_cleanup_temp_files_hours"
                                   value="${currentConfig.limits?.cleanup_temp_files_hours || 24}" min="1">
                        </div>
                    </div>
                </div>

                <!-- UI配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-palette"></i>用户界面配置
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">默认预览模式</label>
                            <select class="form-select" id="ui_default_preview_mode">
                                <option value="render" ${currentConfig.ui?.default_preview_mode === 'render' ? 'selected' : ''}>渲染模式</option>
                                <option value="raw" ${currentConfig.ui?.default_preview_mode === 'raw' ? 'selected' : ''}>原始模式</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">通知持续时间 (ms)</label>
                            <input type="number" class="form-control" id="ui_notification_duration"
                                   value="${currentConfig.ui?.notification_duration || 5000}" min="1000">
                        </div>
                        <div class="col-md-12 mt-3">
                            <label class="form-label">页面标题</label>
                            <input type="text" class="form-control" id="ui_page_title"
                                   value="${currentConfig.ui?.page_title || 'MarkItDown Web - 文档转换平台'}">
                        </div>
                        <div class="col-md-12 mt-3">
                            <label class="form-label">主题</label>
                            <select class="form-select" id="ui_theme">
                                <option value="default" ${currentConfig.ui?.theme === 'default' ? 'selected' : ''}>默认主题</option>
                                <option value="dark" ${currentConfig.ui?.theme === 'dark' ? 'selected' : ''}>深色主题</option>
                                <option value="light" ${currentConfig.ui?.theme === 'light' ? 'selected' : ''}>浅色主题</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 功能开关 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-toggle-on"></i>功能开关
                    </h3>
                    <div class="feature-switch">
                        <label class="form-label mb-0">批量转换功能</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feature_enable_batch_conversion"
                                   ${currentConfig.feature_flags?.enable_batch_conversion ? 'checked' : ''}>
                        </div>
                    </div>
                    <div class="feature-switch">
                        <label class="form-label mb-0">历史记录管理</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feature_enable_history_management"
                                   ${currentConfig.feature_flags?.enable_history_management ? 'checked' : ''}>
                        </div>
                    </div>
                    <div class="feature-switch">
                        <label class="form-label mb-0">文件预览功能</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feature_enable_file_preview"
                                   ${currentConfig.feature_flags?.enable_file_preview ? 'checked' : ''}>
                        </div>
                    </div>
                    <div class="feature-switch">
                        <label class="form-label mb-0">密码保护功能</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feature_enable_password_protection"
                                   ${currentConfig.feature_flags?.enable_password_protection ? 'checked' : ''}>
                        </div>
                    </div>
                    <div class="feature-switch">
                        <label class="form-label mb-0">自动清理临时文件</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feature_auto_cleanup_temp_files"
                                   ${currentConfig.feature_flags?.auto_cleanup_temp_files ? 'checked' : ''}>
                        </div>
                    </div>
                </div>
            `;

            formContainer.innerHTML = html;
        }

        async function saveConfig() {
            try {
                // 收集表单数据
                const newConfig = {
                    app: {
                        debug: document.getElementById('app_debug').value === 'true',
                        host: document.getElementById('app_host').value,
                        port: parseInt(document.getElementById('app_port').value)
                    },
                    storage: {
                        upload_folder: document.getElementById('storage_upload_folder').value,
                        download_folder: document.getElementById('storage_download_folder').value,
                        history_file: document.getElementById('storage_history_file').value,
                        batch_status_file: document.getElementById('storage_batch_status_file').value
                    },
                    limits: {
                        max_file_size: parseInt(document.getElementById('limits_max_file_size').value),
                        max_history_records: parseInt(document.getElementById('limits_max_history_records').value),
                        batch_status_poll_interval: parseInt(document.getElementById('limits_batch_status_poll_interval').value),
                        cleanup_temp_files_hours: parseInt(document.getElementById('limits_cleanup_temp_files_hours').value)
                    },
                    ui: {
                        default_preview_mode: document.getElementById('ui_default_preview_mode').value,
                        notification_duration: parseInt(document.getElementById('ui_notification_duration').value),
                        page_title: document.getElementById('ui_page_title').value,
                        theme: document.getElementById('ui_theme').value
                    },
                    feature_flags: {
                        enable_batch_conversion: document.getElementById('feature_enable_batch_conversion').checked,
                        enable_history_management: document.getElementById('feature_enable_history_management').checked,
                        enable_file_preview: document.getElementById('feature_enable_file_preview').checked,
                        enable_password_protection: document.getElementById('feature_enable_password_protection').checked,
                        auto_cleanup_temp_files: document.getElementById('feature_auto_cleanup_temp_files').checked
                    }
                };

                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newConfig)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('配置保存成功！部分配置可能需要重启应用才能生效。', 'success');
                    originalConfig = JSON.parse(JSON.stringify(newConfig));
                } else {
                    showMessage('保存配置失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('保存配置异常: ' + error.message, 'danger');
            }
        }

        async function reloadConfig() {
            try {
                const response = await fetch('/api/config/reload', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('配置重新加载成功！', 'success');
                    await loadConfig();
                } else {
                    showMessage('重新加载配置失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('重新加载配置异常: ' + error.message, 'danger');
            }
        }

        function exportConfig() {
            const dataStr = JSON.stringify(currentConfig, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'markitdown_config_' + new Date().toISOString().slice(0, 10) + '.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showMessage('配置已导出', 'success');
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);

                    const response = await fetch('/api/config', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(importedConfig)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showMessage('配置导入成功！', 'success');
                        await loadConfig();
                    } else {
                        showMessage('导入配置失败: ' + result.message, 'danger');
                    }
                } catch (error) {
                    showMessage('导入配置异常: ' + error.message, 'danger');
                }
            };

            reader.readAsText(file);
            // 重置文件输入
            event.target.value = '';
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('statusMessage');
            messageContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // 自动移除消息
            setTimeout(() => {
                const alert = messageContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // 监听页面离开事件
        window.addEventListener('beforeunload', (e) => {
            if (JSON.stringify(currentConfig) !== JSON.stringify(originalConfig)) {
                e.preventDefault();
                e.returnValue = '您有未保存的配置更改，确定要离开吗？';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>