<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - MarkItDown Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .config-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 30px auto;
            padding: 40px;
            max-width: 1200px;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .section-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .section-title i {
            margin-right: 10px;
            color: #667eea;
        }

        .form-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .alert {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .config-value {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            border-left: 3px solid #667eea;
        }

        .feature-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .feature-switch:last-child {
            border-bottom: none;
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="config-container">
            <!-- 页面标题 -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-dark">
                    <i class="fas fa-cogs text-primary me-3"></i>配置管理
                </h1>
                <p class="text-muted">管理 MarkItDown Web 应用的配置参数</p>
            </div>

            <!-- 操作按钮 -->
            <div class="mb-4">
                <div class="d-flex gap-3">
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>保存配置
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="reloadConfig()">
                        <i class="fas fa-sync-alt me-2"></i>重新加载
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="exportConfig()">
                        <i class="fas fa-download me-2"></i>导出配置
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload me-2"></i>导入配置
                    </button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importConfig(event)">
                </div>
            </div>

            <!-- 状态消息 -->
            <div id="statusMessage"></div>

            <!-- 配置表单 -->
            <div id="configForm" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-3">正在加载配置...</p>
            </div>

            <!-- 返回链接 -->
            <div class="text-center mt-4">
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>返回主页
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentConfig = {};
        let originalConfig = {};

        // 页面加载时获取配置
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
        });

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const result = await response.json();

                if (result.success) {
                    currentConfig = result.config;
                    originalConfig = JSON.parse(JSON.stringify(result.config)); // 深拷贝
                    renderConfigForm();
                } else {
                    showMessage('加载配置失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('加载配置异常: ' + error.message, 'danger');
            }
        }

        function renderConfigForm() {
            const formContainer = document.getElementById('configForm');

            let html = `
                <!-- 应用配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-server"></i>应用配置
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Debug模式</label>
                            <select class="form-select" id="app_debug">
                                <option value="true" ${currentConfig.app?.debug ? 'selected' : ''}>启用</option>
                                <option value="false" ${!currentConfig.app?.debug ? 'selected' : ''}>禁用</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">监听端口</label>
                            <input type="number" class="form-control" id="app_port"
                                   value="${currentConfig.app?.port || 5000}" min="1" max="65535">
                        </div>
                        <div class="col-md-12 mt-3">
                            <label class="form-label">监听主机</label>
                            <input type="text" class="form-control" id="app_host"
                                   value="${currentConfig.app?.host || '0.0.0.0'}">
                        </div>
                    </div>
                </div>

                <!-- 存储配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-folder-open"></i>存储配置
                    </h3>
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">上传目录</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="storage_upload_folder"
                                       value="${currentConfig.storage?.upload_folder || 'uploads'}">
                                <button class="btn btn-outline-secondary" type="button" onclick="selectFolder('storage_upload_folder')">
                                    <i class="fas fa-folder-open"></i> 选择
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">下载目录</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="storage_download_folder"
                                       value="${currentConfig.storage?.download_folder || 'downloads'}">
                                <button class="btn btn-outline-secondary" type="button" onclick="selectFolder('storage_download_folder')">
                                    <i class="fas fa-folder-open"></i> 选择
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8 mt-3">
                            <label class="form-label">历史记录文件</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="storage_history_file"
                                       value="${currentConfig.storage?.history_file || 'history.json'}">
                                <button class="btn btn-outline-secondary" type="button" onclick="selectFile('storage_history_file')">
                                    <i class="fas fa-file"></i> 选择
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 限制配置 -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-sliders-h"></i>限制配置
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">最大文件大小 (bytes)</label>
                            <input type="number" class="form-control" id="limits_max_file_size"
                                   value="${currentConfig.limits?.max_file_size || 104857600}" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">最大历史记录数</label>
                            <input type="number" class="form-control" id="limits_max_history_records"
                                   value="${currentConfig.limits?.max_history_records || 100}" min="1">
                        </div>
                    </div>
                </div>
            `;

            formContainer.innerHTML = html;
        }

        async function saveConfig() {
            try {
                // 显示保存进度
                showMigrationProgress();

                // 收集表单数据
                const newConfig = {
                    app: {
                        debug: document.getElementById('app_debug').value === 'true',
                        host: document.getElementById('app_host').value,
                        port: parseInt(document.getElementById('app_port').value)
                    },
                    storage: {
                        upload_folder: document.getElementById('storage_upload_folder').value,
                        download_folder: document.getElementById('storage_download_folder').value,
                        history_file: document.getElementById('storage_history_file').value
                    },
                    limits: {
                        max_file_size: parseInt(document.getElementById('limits_max_file_size').value),
                        max_history_records: parseInt(document.getElementById('limits_max_history_records').value)
                    }
                };

                updateProgressStatus('正在验证配置路径...', 10);

                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newConfig)
                });

                updateProgressStatus('正在处理配置...', 50);
                const result = await response.json();

                if (result.success) {
                    updateProgressStatus('配置保存成功！', 100);

                    // 显示详细结果
                    let message = '配置保存成功！部分配置可能需要重启应用才能生效。';
                    if (result.requires_migration) {
                        message = `配置保存成功！已迁移 ${result.migrated_files_count} 个文件到新位置。`;
                        if (result.migration_details) {
                            showMigrationDetails(result.migration_details);
                        }
                    }

                    showMessage(message, result.requires_migration ? 'info' : 'success');
                    originalConfig = JSON.parse(JSON.stringify(newConfig));
                } else {
                    updateProgressStatus('保存失败', 0);
                    showMessage('保存配置失败: ' + result.message, 'danger');
                }

                // 隐藏进度条（延迟显示）
                setTimeout(() => hideMigrationProgress(), 2000);

            } catch (error) {
                updateProgressStatus('保存配置异常: ' + error.message, 0);
                showMessage('保存配置异常: ' + error.message, 'danger');
                setTimeout(() => hideMigrationProgress(), 3000);
            }
        }

        function showMigrationProgress() {
            const progressHtml = `
                <div id="migrationProgress" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small" id="progressStatus">准备保存配置...</span>
                        <span class="text-muted small" id="progressPercentage">0%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            `;

            // 在保存按钮后面插入进度条
            const saveButton = document.querySelector('button[onclick="saveConfig()"]');
            saveButton.insertAdjacentHTML('afterend', progressHtml);
        }

        function hideMigrationProgress() {
            const progress = document.getElementById('migrationProgress');
            if (progress) {
                progress.remove();
            }
        }

        function updateProgressStatus(status, percentage) {
            const statusEl = document.getElementById('progressStatus');
            const percentageEl = document.getElementById('progressPercentage');
            const progressBar = document.getElementById('progressBar');

            if (statusEl) statusEl.textContent = status;
            if (percentageEl) percentageEl.textContent = percentage + '%';
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                if (percentage === 100) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                } else if (percentage === 0) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                }
            }
        }

        function showMigrationDetails(details) {
            const detailsHtml = `
                <div class="alert alert-info mt-3" id="migrationDetails">
                    <h6><i class="fas fa-info-circle me-2"></i>文件迁移详情</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>原始路径:</strong>
                            <ul class="small mt-1">
                                <li>上传: ${details.old_paths.upload_folder || 'uploads'}</li>
                                <li>下载: ${details.old_paths.download_folder || 'downloads'}</li>
                                <li>历史: ${details.old_paths.history_file || 'history.json'}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>新路径:</strong>
                            <ul class="small mt-1">
                                <li>上传: ${details.new_paths.upload_folder}</li>
                                <li>下载: ${details.new_paths.download_folder}</li>
                                <li>历史: ${details.new_paths.history_file}</li>
                            </ul>
                        </div>
                    </div>
                    ${details.migrated_files && details.migrated_files.length > 0 ? `
                        <details class="mt-2">
                            <summary class="small">查看迁移文件列表 (${details.migrated_files.length} 个文件)</summary>
                            <div class="small text-muted mt-2" style="max-height: 200px; overflow-y: auto;">
                                ${details.migrated_files.map(file => `<div>• ${file}</div>`).join('')}
                            </div>
                        </details>
                    ` : ''}
                </div>
            `;

            // 在状态消息区域插入详情
            const messageContainer = document.getElementById('statusMessage');
            messageContainer.insertAdjacentHTML('beforeend', detailsHtml);
        }

        async function reloadConfig() {
            try {
                const response = await fetch('/api/config/reload', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('配置重新加载成功！', 'success');
                    await loadConfig();
                } else {
                    showMessage('重新加载配置失败: ' + result.message, 'danger');
                }
            } catch (error) {
                showMessage('重新加载配置异常: ' + error.message, 'danger');
            }
        }

        function exportConfig() {
            const dataStr = JSON.stringify(currentConfig, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'markitdown_config_' + new Date().toISOString().slice(0, 10) + '.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showMessage('配置已导出', 'success');
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);

                    const response = await fetch('/api/config', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(importedConfig)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showMessage('配置导入成功！', 'success');
                        await loadConfig();
                    } else {
                        showMessage('导入配置失败: ' + result.message, 'danger');
                    }
                } catch (error) {
                    showMessage('导入配置异常: ' + error.message, 'danger');
                }
            };

            reader.readAsText(file);
            // 重置文件输入
            event.target.value = '';
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('statusMessage');
            messageContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // 自动移除消息
            setTimeout(() => {
                const alert = messageContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // 文件夹选择功能
        async function selectFolder(inputId) {
            // 由于浏览器安全限制，我们使用提示框让用户手动输入路径
            const currentPath = document.getElementById(inputId).value;

            // 提供路径建议
            const pathSuggestions = [
                'O:/Project/markitdown/new_uploads',
                'O:/Project/markitdown/new_downloads',
                'D:/MarkItDown/uploads',
                'C:/Users/' + (navigator.userAgent.includes('Windows') ? 'Public' : 'user') + '/Documents/MarkItDown'
            ];

            const suggestion = pathSuggestions.find(s => s.includes(inputId.includes('upload') ? 'upload' : 'download')) || currentPath;

            const path = prompt(
                `请输入${inputId.includes('upload') ? '上传' : '下载'}文件夹的完整路径:\n\n` +
                `示例路径:\n${pathSuggestions.slice(0, 3).join('\n')}\n\n` +
                `当前路径: ${currentPath}`,
                suggestion
            );

            if (path && path.trim() !== '') {
                // 验证路径格式
                if (!path.includes(':') && !path.startsWith('/')) {
                    alert('请输入完整的绝对路径（如：O:/Project/markitdown/uploads）');
                    return;
                }

                document.getElementById(inputId).value = path.trim();

                // 显示更新的反馈
                const inputElement = document.getElementById(inputId);
                inputElement.classList.add('is-valid');
                inputElement.style.borderColor = '#28a745';

                // 显示提示信息
                showPathUpdateMessage(inputId, path.trim());

                setTimeout(() => {
                    inputElement.classList.remove('is-valid');
                    inputElement.style.borderColor = '';
                }, 3000);
            }
        }

        function showPathUpdateMessage(inputId, newPath) {
            const fieldName = inputId.includes('upload') ? '上传' :
                          inputId.includes('download') ? '下载' : '历史文件';

            const messageHtml = `
                <div class="alert alert-info alert-dismissible fade show" role="alert" id="pathUpdateMessage">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>路径已更新</strong>: ${fieldName}目录将设置为 <code>${newPath}</code>
                    <br><small class="text-muted">保存配置后，系统将自动迁移现有文件到新位置</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            const messageContainer = document.getElementById('statusMessage');
            messageContainer.insertAdjacentHTML('beforeend', messageHtml);

            // 3秒后自动移除
            setTimeout(() => {
                const alert = document.getElementById('pathUpdateMessage');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

    // 文件选择功能
    async function selectFile(inputId) {
        try {
            const input = document.createElement('input');
            input.type = 'file';
            input.style.display = 'none';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById(inputId).value = file.name;
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        } catch (error) {
            // 如果不支持文件选择，使用传统方式
            const path = prompt('请输入文件路径:', document.getElementById(inputId).value);
            if (path) {
                document.getElementById(inputId).value = path;
            }
        }
    }

        // 监听页面离开事件
        window.addEventListener('beforeunload', (e) => {
            if (JSON.stringify(currentConfig) !== JSON.stringify(originalConfig)) {
                e.preventDefault();
                e.returnValue = '您有未保存的配置更改，确定要离开吗？';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>